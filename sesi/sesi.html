<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chotoba - Sesi Belajar</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="icon" href="../img/logo.svg" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1001;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <script>
      (function() {
        const savedTheme = localStorage.getItem('theme');
        const userPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (savedTheme === 'dark' || (!savedTheme && userPrefersDark)) {
          document.body.classList.add('dark-mode');
        }
      })();
    </script>

    <canvas id="confetti-canvas"></canvas>

    <div class="header-controls">
        <a href="../index.html" class="nav-btn-svg" id="back-to-menu-btn" title="Kembali ke Menu">
            <img src="../img/left.svg" alt="Menu Utama">
        </a>
        <button class="theme-toggle-btn" id="theme-toggle-btn" title="Ganti Tema">
            <img src="../img/sun.svg" alt="Light Mode" class="icon-sun">
            <img src="../img/moon.svg" alt="Dark Mode" class="icon-moon">
        </button>
    </div>

    <div id="app" class="app-container">
        <div class="card-scene-wrapper">
             <img src="../img/logo.svg" class="watermark-logo" alt="Logo Watermark">

            <div class="card-scene">
                <div class="card" id="flashcard">
                    <div class="card__face card__face--front" id="card-front">Memuat Data...</div>
                    <div class="card__face card__face--back" id="card-back"></div>
                </div>
            </div>
        </div>

        <div class="controls-container" id="controls-container">
            <div class="autoplay-controls" id="autoplay-controls" style="display: none;">
                <label for="autoplay-speed">Kecepatan: <span id="autoplay-speed-value">3</span> detik</label>
                <input type="range" id="autoplay-speed" min="1" max="10" value="3" class="speed-slider">
            </div>

            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="card-counter" id="card-counter">0 / 0</div>

            <div class="button-bar controls-bebas">
                <div id="prev-button-svg" class="nav-btn-svg"><img src="../img/left.svg" alt="Sebelumnya"></div>
                <div id="shuffle-button-bebas" class="shuffle-btn"><img src="../img/acak.svg" alt="Acak Kartu"></div>
                <div id="tts-button" class="nav-btn-svg" title="Aktifkan Audio"><img src="../img/audio.svg" alt="Audio TTS"></div>
                <div id="auto-play-button" class="nav-btn-svg"><img src="../img/otomatis.svg" alt="Otomatis"></div>
                <div id="next-button-svg" class="nav-btn-svg"><img src="../img/right.svg" alt="Selanjutnya"></div>
            </div>

            <div class="button-bar controls-test">
                <div id="prev-button-svg-test" class="nav-btn-svg"><img src="../img/left.svg" alt="Sebelumnya"></div>
                <button id="btn-action-wrong" class="btn-action">
                    <img src="../img/silang.svg" alt=""> Salah
                </button>
                <button id="btn-action-correct" class="btn-action">
                    <img src="../img/ceklis.svg" alt=""> Benar
                </button>
                <div id="shuffle-button-test" class="shuffle-btn"><img src="../img/acak.svg" alt="Acak Kartu"></div>

                <div id="wrong-button-svg" class="nav-btn-svg"><img src="../img/silang.svg" alt="Salah"></div>
                <div id="correct-button-svg" class="nav-btn-svg"><img src="../img/ceklis.svg" alt="Benar"></div>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <p id="modal-text" style="font-size: 1.2rem; margin-bottom: 2rem;">Teks modal default</p>
            <div class="modal-buttons" style="flex-direction: row; justify-content: center;">
                <button id="modal-button-yes" class="modal-button btn-primary" style="min-width: 100px;">Ya</button>
                <button id="modal-button-no" class="modal-button btn-secondary" style="min-width: 100px; margin-left: 1rem;">Tidak</button>
            </div>
        </div>
    </div>

    <script src="../js/app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const progressBar = document.getElementById('progress-bar');
            const counterElement = document.getElementById('card-counter');

            if (counterElement) {
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if ((mutation.type === 'childList' || mutation.type === 'characterData') && counterElement.textContent) {
                            try {
                                const text = counterElement.textContent;
                                const parts = text.split('/').map(s => parseInt(s.trim()));

                                if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1]) && parts[1] > 0) {
                                    const [current, total] = parts;

                                    let percentage = 0;
                                    const appBody = document.body;

                                    if (appBody.classList.contains('mode-test')) {
                                         const cardIndex = parseInt(parts[0]) - 1;
                                         if(!isNaN(cardIndex) && cardIndex >= 0) {
                                             percentage = ((cardIndex + 1) / total) * 100;
                                         }
                                    } else {
                                        percentage = (current / total) * 100;
                                    }

                                    if (progressBar) progressBar.style.width = `${percentage}%`;
                                } else if (parts.length === 2 && parts[1] === 0) {
                                    if (progressBar) progressBar.style.width = '0%';
                                }
                            } catch (e) {
                                console.error("Error updating progress bar:", e);
                                if (progressBar) progressBar.style.width = '0%';
                            }
                        }
                    });
                });
                observer.observe(counterElement, { childList: true, subtree: true, characterData: true });

                 try {
                     const text = counterElement.textContent;
                     const parts = text.split('/').map(s => parseInt(s.trim()));
                     if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1]) && parts[1] > 0) {
                         const [current, total] = parts;
                         let percentage = (current / total) * 100;
                          if (document.body.classList.contains('mode-test')) {
                              const cardIndex = parseInt(parts[0]) - 1;
                              if(!isNaN(cardIndex) && cardIndex >= 0) percentage = ((cardIndex + 1) / total) * 100;
                          }
                         if (progressBar) progressBar.style.width = `${percentage}%`;
                     } else if (progressBar) {
                          progressBar.style.width = '0%';
                     }
                 } catch(e){
                      if (progressBar) progressBar.style.width = '0%';
                 }
            }


            const btnActionWrong = document.getElementById('btn-action-wrong');
            const btnActionCorrect = document.getElementById('btn-action-correct');
            const originalWrongBtn = document.getElementById('wrong-button-svg');
            const originalCorrectBtn = document.getElementById('correct-button-svg');

            if (btnActionWrong && originalWrongBtn) {
                btnActionWrong.addEventListener('click', () => originalWrongBtn.click());
            }
            if (btnActionCorrect && originalCorrectBtn) {
                btnActionCorrect.addEventListener('click', () => originalCorrectBtn.click());
            }

            const appContainer = document.getElementById('app');
            const controlsContainer = document.getElementById('controls-container');
            const autoPlayButton = document.getElementById('auto-play-button');
            const autoPlayControls = document.getElementById('autoplay-controls');
            const autoPlaySpeedSlider = document.getElementById('autoplay-speed');
            const autoPlaySpeedValue = document.getElementById('autoplay-speed-value');
            const flashcard = document.getElementById('flashcard');
            const nextButtonSvg = document.getElementById('next-button-svg');

            let isAutoPlaying = false;
            let autoPlayTimer = null;
            let currentSpeed = 3000;
            let programmaticClick = false;

            function updateAppPadding() {
                if (controlsContainer && appContainer) {
                    const controlsHeight = controlsContainer.offsetHeight;
                    appContainer.style.setProperty('--controls-height', `${controlsHeight + 20}px`);
                }
            }
            updateAppPadding();

            function autoPlayStep() {
                if (!isAutoPlaying || !flashcard || !nextButtonSvg) return;

                if (flashcard.classList.contains('is-flipped')) {
                    programmaticClick = true;
                    flashcard.click();
                }

                autoPlayTimer = setTimeout(() => {
                    if (!isAutoPlaying) return;

                    if (!flashcard.classList.contains('is-flipped')) {
                         programmaticClick = true;
                         flashcard.click();
                    }

                    autoPlayTimer = setTimeout(() => {
                        if (!isAutoPlaying) return;
                        nextButtonSvg.click();

                    }, currentSpeed);
                }, currentSpeed);
            }

            function startAutoPlay() {
                isAutoPlaying = true;
                if(autoPlayButton) autoPlayButton.classList.add('active');
                if(autoPlayControls) autoPlayControls.style.display = 'flex';
                updateAppPadding();
                autoPlayStep();
            }

            function stopAutoPlay() {
                isAutoPlaying = false;
                if(autoPlayButton) autoPlayButton.classList.remove('active');
                if(autoPlayControls) autoPlayControls.style.display = 'none';
                updateAppPadding();
                clearTimeout(autoPlayTimer);
            }

            if (autoPlayButton) {
                autoPlayButton.addEventListener('click', () => {
                    if (isAutoPlaying) {
                        stopAutoPlay();
                    } else {
                        if (document.body.classList.contains('mode-bebas')) {
                            startAutoPlay();
                        }
                    }
                });
            }

            if (autoPlaySpeedSlider && autoPlaySpeedValue) {
                autoPlaySpeedSlider.addEventListener('input', () => {
                    const speedInSeconds = parseInt(autoPlaySpeedSlider.value);
                    currentSpeed = speedInSeconds * 1000;
                    autoPlaySpeedValue.textContent = speedInSeconds;

                    if (isAutoPlaying) {
                        clearTimeout(autoPlayTimer);
                        autoPlayStep();
                    }
                });
            }

             if (flashcard) {
                flashcard.addEventListener('click', () => {
                    if (programmaticClick) {
                        programmaticClick = false;
                        return;
                    }

                    if(isAutoPlaying) {
                        stopAutoPlay();
                    }
                });
             }

             const prevButtonSvg = document.getElementById('prev-button-svg');
             if (prevButtonSvg) {
                 prevButtonSvg.addEventListener('click', stopAutoPlay);
             }
             const shuffleButtonBebas = document.getElementById('shuffle-button-bebas');
             if(shuffleButtonBebas) {
                shuffleButtonBebas.addEventListener('click', stopAutoPlay);
             }
             
             const ttsButton = document.getElementById('tts-button');
             if (ttsButton) {
                 ttsButton.addEventListener('click', stopAutoPlay);
             }


             if (nextButtonSvg) {
                 nextButtonSvg.addEventListener('click', () => {
                     if(isAutoPlaying) {
                         clearTimeout(autoPlayTimer);
                         autoPlayStep();
                     }
                 });
             }

             const resizeObserver = new ResizeObserver(() => {
                updateAppPadding();
             });
             if(controlsContainer) resizeObserver.observe(controlsContainer);
        });
    </script>
</body>
</html>

